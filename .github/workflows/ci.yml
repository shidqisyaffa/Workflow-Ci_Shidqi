name: MLflow CI - SKILLED

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
      # Tahap 1: Set up job (otomatis oleh GitHub Actions)
      
      # Tahap 2: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Tahap 3: Setup Python 3.12.7
      - name: Set up Python 3.12.7
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.7'
      
      # Tahap 4: Check environment
      - name: Check environment
        run: |
          echo "=== Python Environment Check ==="
          python --version
          pip --version
          echo "=== Working Directory ==="
          pwd
          echo "=== Directory Contents ==="
          ls -la
          echo "=== MLProject Contents ==="
          ls -la MLProject/
      
      # Tahap 5: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow==2.19.0 pandas numpy scikit-learn
      
      # Tahap 6: Set MLflow Tracking URI
      - name: Set MLflow Tracking URI
        run: |
          mkdir -p mlruns
          echo "MLFLOW_TRACKING_URI=file://$(pwd)/mlruns" >> $GITHUB_ENV
          echo "MLflow Tracking URI set to: file://$(pwd)/mlruns"
      
      # Tahap 7: Run MLflow Project
      - name: Run MLflow Project
        run: |
          echo "=== Starting MLflow Project Training ==="
          cd MLProject
          mlflow run . --env-manager=local
          echo "=== MLflow Project Training Complete ==="
      
      # Tahap 8: Get latest MLflow run_id
      - name: Get latest MLflow run_id
        id: mlflow_run
        run: |
          echo "=== Finding Latest MLflow Run ==="
          # Find the experiment directory
          EXPERIMENT_DIR=$(find . -path "*/mlruns/0" -type d 2>/dev/null | head -n 1)
          if [ -z "$EXPERIMENT_DIR" ]; then
            EXPERIMENT_DIR="./MLProject/mlruns/0"
          fi
          echo "Experiment directory: $EXPERIMENT_DIR"
          
          # Get the latest run_id
          if [ -d "$EXPERIMENT_DIR" ]; then
            RUN_ID=$(ls -t "$EXPERIMENT_DIR" 2>/dev/null | grep -v meta.yaml | head -n 1)
            echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
            echo "Latest run_id: $RUN_ID"
          else
            echo "No mlruns directory found, creating placeholder"
            echo "run_id=no-run-found" >> $GITHUB_OUTPUT
          fi
          
          # Show mlruns structure
          echo "=== MLruns Structure ==="
          find . -name "mlruns" -type d -exec ls -la {} \; 2>/dev/null || echo "No mlruns found"
      
      # Tahap 9: Install additional Python dependencies (verification)
      - name: Verify Python dependencies
        run: |
          echo "=== Installed Python Packages ==="
          pip list | grep -E "(mlflow|pandas|numpy|scikit-learn)"
      
      # Tahap 10: Upload artifact to GitHub
      - name: Upload model artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-model-${{ github.run_number }}
          path: |
            MLProject/mlruns/
            mlruns/
          retention-days: 30
          if-no-files-found: warn

      # Post step: Complete job (otomatis oleh GitHub Actions)
