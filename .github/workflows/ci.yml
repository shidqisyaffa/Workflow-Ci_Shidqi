name: MLflow CI - SKILLED

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
      # Tahap 1: Set up job (otomatis oleh GitHub Actions)
      
      # Tahap 2: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Tahap 3: Setup Python 3.12.7
      - name: Set up Python 3.12.7
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.7'
      
      # Tahap 4: Check environment
      - name: Check environment
        run: |
          echo "=== Python Environment Check ==="
          python --version
          pip --version
          echo "=== Working Directory ==="
          pwd
          echo "=== Directory Contents ==="
          ls -la
          echo "=== MLProject Contents ==="
          ls -la MLProject/
      
      # Tahap 5: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow==2.19.0 pandas numpy scikit-learn
      
      # Tahap 6: Set MLflow Tracking URI
      - name: Set MLflow Tracking URI
        run: |
          echo "Setting up MLflow tracking..."
          echo "MLFLOW_TRACKING_URI=${{ github.workspace }}/mlruns" >> $GITHUB_ENV
          echo "MLflow Tracking URI: ${{ github.workspace }}/mlruns"
      
      # Tahap 7: Run MLflow Project
      - name: Run MLflow Project
        env:
          MLFLOW_TRACKING_URI: ${{ github.workspace }}/mlruns
        run: |
          echo "=== Starting MLflow Project Training ==="
          echo "MLFLOW_TRACKING_URI=$MLFLOW_TRACKING_URI"
          mlflow run MLProject --env-manager=local
          echo "=== MLflow Project Training Complete ==="
      
      # Tahap 8: Get latest MLflow run_id
      - name: Get latest MLflow run_id
        id: mlflow_run
        run: |
          echo "=== Finding Latest MLflow Run ==="
          echo "Looking in: ${{ github.workspace }}/mlruns"
          ls -la ${{ github.workspace }}/mlruns/ || echo "mlruns not found"
          
          # Find experiment directories
          if [ -d "${{ github.workspace }}/mlruns" ]; then
            EXPERIMENT_ID=$(ls ${{ github.workspace }}/mlruns/ | grep -v "\.trash" | head -n 1)
            echo "Experiment ID: $EXPERIMENT_ID"
            
            if [ -n "$EXPERIMENT_ID" ] && [ -d "${{ github.workspace }}/mlruns/$EXPERIMENT_ID" ]; then
              RUN_ID=$(ls -t "${{ github.workspace }}/mlruns/$EXPERIMENT_ID" 2>/dev/null | grep -v meta.yaml | head -n 1)
              echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
              echo "Latest run_id: $RUN_ID"
            fi
          else
            echo "No mlruns directory found"
            echo "run_id=no-run-found" >> $GITHUB_OUTPUT
          fi
          
          echo "=== MLruns Structure ==="
          find ${{ github.workspace }}/mlruns -type d -maxdepth 2 2>/dev/null || echo "No structure found"
      
      # Tahap 9: Install additional Python dependencies (verification)
      - name: Verify Python dependencies
        run: |
          echo "=== Installed Python Packages ==="
          pip list | grep -E "(mlflow|pandas|numpy|scikit-learn)"
      
      # Tahap 10: Upload artifact to GitHub
      - name: Upload model artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-model-${{ github.run_number }}
          path: ${{ github.workspace }}/mlruns/
          retention-days: 30
          if-no-files-found: warn

      # Post step: Complete job (otomatis oleh GitHub Actions)
